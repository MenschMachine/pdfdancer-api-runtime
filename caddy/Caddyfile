# Primary HTTPS site (HTTP/3 automatically enabled)
https://{$DOMAIN} {
	log

	@v0 path_regexp v0 ^/v0/(.*)$
	rewrite @v0 /{http.regexp.v0.1}?{query}&v=0

	handle {
		reverse_proxy {$BACKEND_API_URL}
	}

	encode zstd gzip
}

# Primary HTTP site (no redirect)
http://{$DOMAIN} {
	log

	@v0 path_regexp v0 ^/v0/(.*)$
	rewrite @v0 /{http.regexp.v0.1}?{query}&v=0

	handle {
		reverse_proxy {$BACKEND_API_URL}
	}

	encode zstd gzip
}

# Catch-all redirect for any other hostname
# (e.g., www.domain.com, example.net, IP address, etc.)
:80, :443 {
	@notPrimary host != {$DOMAIN}
	redir @notPrimary https://{$DOMAIN}{uri}
}